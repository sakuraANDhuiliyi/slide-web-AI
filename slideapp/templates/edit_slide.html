<!DOCTYPE html>
<html>
<head>
    <title>{{ slide.title }}</title>
    <style>
        body {
            display: flex;
            height: 100vh;
            margin: 0;
        }

        #editor {
            width: 50%;
            height: 100%;
        }

        #preview {
            width: 50%;
            height: 100%;
        }

        iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        /* å·¥å…·æ æ ·å¼ */
        #toolbar {
            position: fixed;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
        }

        /* è¿”å›ä¸»é¡µæŒ‰é’®æ ·å¼ */
        .return-button {
            background-color: gray;
            border: none;
            color: #ffffff;
            padding: 10px 15px;
            font-size: 14px;
            cursor: pointer;
            border-radius: 0;
        }

        .return-button:hover {
            background-color: gray;
        }

        /* å›¾ç‰‡æœç´¢æŒ‰é’®æ ·å¼ */
        .image-button {
            background-color: #4CAF50;
            border: none;
            color: #ffffff;
            padding: 10px 15px;
            font-size: 14px;
            cursor: pointer;
            border-radius: 0;
        }

        .image-button:hover {
            background-color: #45a049;
        }

        /* å¯¼å‡ºæŒ‰é’®æ ·å¼ */
        .export-button {
            background-color: #2196F3;
            border: none;
            color: #ffffff;
            padding: 10px 15px;
            font-size: 14px;
            cursor: pointer;
            border-radius: 0;
        }

        .export-button:hover {
            background-color: #0b7dda;
        }

        /* å›¾ç‰‡æœç´¢æ¨¡æ€æ¡†æ ·å¼ */
        #imageSearchModal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 60%;
            max-height: 70vh;
            overflow-y: auto;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
        }

        .image-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .image-item {
            position: relative;
            cursor: pointer;
        }

        .image-item img {
            width: 100%;
            border-radius: 5px;
        }

        .image-item:hover::after {
            content: 'ç‚¹å‡»æ’å…¥';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            font-size: 16px;
            border-radius: 5px;
        }

        #imageSearchForm {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        #imageSearchForm input {
            flex-grow: 1;
            padding: 8px;
            border: 1px solid #ddd;
        }

        #imageSearchForm button {
            background-color: #2196F3;
            color: white;
            border: none;
            padding: 8px 15px;
            cursor: pointer;
        }

        #imageSearchForm button:hover {
            background-color: #0b7dda;
        }

        #loadingImages {
            display: none;
            text-align: center;
            margin-top: 20px;
        }

        #noResults {
            display: none;
            text-align: center;
            margin-top: 20px;
            color: #666;
        }

        .credit-text {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        /* æ‰‹åŠ¨è°ƒèŠ‚é¢æ¿æ ·å¼ */
        #adjustmentPanel {
            position: fixed;
            top: 50%;
            right: 20px;
            transform: translateY(-50%);
            width: 280px;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            display: none;
        }

        .panel-header {
            background: #f8f9fa;
            padding: 12px 16px;
            border-bottom: 1px solid #eee;
            border-radius: 8px 8px 0 0;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-close {
            cursor: pointer;
            color: #666;
            font-size: 18px;
            font-weight: normal;
        }

        .panel-close:hover {
            color: #333;
        }

        .panel-content {
            padding: 16px;
            max-height: 400px;
            overflow-y: auto;
        }

        .control-group {
            margin-bottom: 20px;
        }

        .control-label {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .control-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .control-input {
            flex: 1;
            padding: 6px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
        }

        .control-slider {
            flex: 1;
            margin: 0 8px;
        }

        .control-value {
            min-width: 40px;
            text-align: center;
            font-size: 12px;
            color: #666;
        }

        .control-buttons {
            display: flex;
            gap: 4px;
            margin-top: 8px;
        }

        .control-btn {
            padding: 4px 8px;
            border: 1px solid #ddd;
            background: #f8f9fa;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
        }

        .control-btn:hover {
            background: #e9ecef;
        }

        .control-btn.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .element-selector {
            border: 1px solid #007bff;
            background: rgba(0,123,255,0.1);
        }

        .quick-actions {
            display: flex;
            gap: 8px;
            margin-top: 16px;
        }

        .quick-btn {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            text-align: center;
        }

        .quick-btn.reset {
            background: #dc3545;
            color: white;
        }

        .quick-btn.apply {
            background: #28a745;
            color: white;
        }

        .quick-btn:hover {
            opacity: 0.9;
        }

        /* è°ƒèŠ‚æŒ‰é’®æ ·å¼ */
        .adjust-button {
            background-color: #FF5722;
            border: none;
            color: #ffffff;
            padding: 10px 15px;
            font-size: 14px;
            cursor: pointer;
            border-radius: 0;
        }

        .adjust-button:hover {
            background-color: #E64A19;
        }
    </style>
</head>
<body>
<!-- å·¥å…·æ  -->
<div id="toolbar">
    <button class="image-button" onclick="openImageSearch()">æœç´¢å›¾ç‰‡</button>
    <button class="adjust-button" onclick="toggleAdjustmentPanel()">æ‰‹åŠ¨è°ƒèŠ‚</button>
    <button class="return-button" onclick="location.href='{% url 'index' %}'">è¿”å›ä¸»é¡µ</button>
    <button class="export-button" onclick="exportSlide()">å¯¼å‡ºPPTX</button>
</div>

<textarea id="editor"></textarea>
<div id="preview">
    <iframe id="preview-iframe"></iframe>
</div>

<!-- å›¾ç‰‡æœç´¢æ¨¡æ€æ¡† -->
<div id="imageSearchModal">
    <div class="modal-content">
        <span class="close" onclick="closeImageSearch()">&times;</span>
        <h2>æœç´¢å›¾ç‰‡</h2>
        <p>è¾“å…¥å…³é”®è¯æœç´¢ç›¸å…³å›¾ç‰‡ã€‚å›¾ç‰‡ç”±Unsplashæä¾›ã€‚</p>
        
        <form id="imageSearchForm" onsubmit="searchImages(event)">
            <input type="text" id="imageKeywords" placeholder="è¾“å…¥å…³é”®è¯..." required>
            <button type="submit">æœç´¢</button>
        </form>
        
        <div id="loadingImages">
            <p>æ­£åœ¨æœç´¢å›¾ç‰‡ï¼Œè¯·ç¨å€™...</p>
        </div>
        
        <div id="noResults">
            <p>æ²¡æœ‰æ‰¾åˆ°ç›¸å…³å›¾ç‰‡ï¼Œè¯·å°è¯•å…¶ä»–å…³é”®è¯ã€‚</p>
        </div>
        
        <div id="imageResults" class="image-grid"></div>
    </div>
</div>

<!-- æ‰‹åŠ¨è°ƒèŠ‚é¢æ¿ -->
<div id="adjustmentPanel">
    <div class="panel-header">
        <span>æ‰‹åŠ¨è°ƒèŠ‚</span>
        <span class="panel-close" onclick="toggleAdjustmentPanel()">&times;</span>
    </div>
    <div class="panel-content">
        <!-- å…ƒç´ é€‰æ‹© -->
        <div class="control-group">
            <div class="control-label">ğŸ“Œ é€‰æ‹©å…ƒç´ </div>
            <div class="control-buttons">
                <div class="control-btn" onclick="selectElementType('text')">æ–‡å­—</div>
                <div class="control-btn" onclick="selectElementType('image')">å›¾ç‰‡</div>
                <div class="control-btn" onclick="selectElementType('heading')">æ ‡é¢˜</div>
            </div>
            <div style="margin-top: 8px; font-size: 12px; color: #666;">
                ç‚¹å‡»é¢„è§ˆåŒºåŸŸä¸­çš„å…ƒç´ æ¥é€‰æ‹©
            </div>
        </div>

        <!-- å­—ä½“å¤§å°è°ƒèŠ‚ -->
        <div class="control-group" id="fontSizeControl">
            <div class="control-label">ğŸ”¤ å­—ä½“å¤§å°</div>
            <div class="control-row">
                <input type="range" class="control-slider" id="fontSizeSlider" 
                       min="12" max="60" value="16" 
                       oninput="adjustFontSize(this.value)">
                <span class="control-value" id="fontSizeValue">16px</span>
            </div>
            <div class="control-buttons">
                <div class="control-btn" onclick="quickFontSize(14)">å°</div>
                <div class="control-btn" onclick="quickFontSize(18)">ä¸­</div>
                <div class="control-btn" onclick="quickFontSize(24)">å¤§</div>
                <div class="control-btn" onclick="quickFontSize(32)">ç‰¹å¤§</div>
            </div>
        </div>

        <!-- å›¾ç‰‡å¤§å°è°ƒèŠ‚ -->
        <div class="control-group" id="imageSizeControl">
            <div class="control-label">ğŸ–¼ï¸ å›¾ç‰‡å¤§å°</div>
            <div class="control-row">
                <span style="font-size: 12px;">å®½åº¦:</span>
                <input type="range" class="control-slider" id="imageWidthSlider" 
                       min="20" max="100" value="80" 
                       oninput="adjustImageSize('width', this.value)">
                <span class="control-value" id="imageWidthValue">80%</span>
            </div>
            <div class="control-row">
                <span style="font-size: 12px;">é«˜åº¦:</span>
                <input type="range" class="control-slider" id="imageHeightSlider" 
                       min="20" max="100" value="60" 
                       oninput="adjustImageSize('height', this.value)">
                <span class="control-value" id="imageHeightValue">60%</span>
            </div>
            <div class="control-buttons">
                <div class="control-btn" onclick="quickImageSize(40, 30)">å°</div>
                <div class="control-btn" onclick="quickImageSize(60, 45)">ä¸­</div>
                <div class="control-btn" onclick="quickImageSize(80, 60)">å¤§</div>
                <div class="control-btn" onclick="quickImageSize(90, 70)">ç‰¹å¤§</div>
            </div>
        </div>

        <!-- ä½ç½®è°ƒèŠ‚ -->
        <div class="control-group" id="positionControl">
            <div class="control-label">ğŸ“ ä½ç½®è°ƒèŠ‚</div>
            <div class="control-buttons">
                <div class="control-btn" onclick="adjustAlignment('left')">å·¦å¯¹é½</div>
                <div class="control-btn" onclick="adjustAlignment('center')">å±…ä¸­</div>
                <div class="control-btn" onclick="adjustAlignment('right')">å³å¯¹é½</div>
            </div>
            <div class="control-row" style="margin-top: 8px;">
                <span style="font-size: 12px;">è¾¹è·:</span>
                <input type="range" class="control-slider" id="marginSlider" 
                       min="0" max="50" value="15" 
                       oninput="adjustMargin(this.value)">
                <span class="control-value" id="marginValue">15px</span>
            </div>
        </div>

        <!-- é¢„è§ˆä»£ç  -->
        <div class="control-group" id="codePreview" style="display: none;">
            <div class="control-label">ğŸ‘€ é¢„è§ˆä»£ç </div>
            <textarea id="markdownPreview" 
                      style="width: 100%; height: 80px; font-family: monospace; font-size: 11px; border: 1px solid #ddd; border-radius: 4px; padding: 8px; resize: vertical;"
                      readonly
                      placeholder="è¿™é‡Œå°†æ˜¾ç¤ºè¦å†™å…¥Markdownçš„ä»£ç ..."></textarea>
            <div style="font-size: 11px; color: #666; margin-top: 4px;">
                ç‚¹å‡»"åº”ç”¨"æŒ‰é’®å°†æ­¤ä»£ç å†™å…¥å·¦ä¾§ç¼–è¾‘å™¨
            </div>
        </div>

        <!-- å¿«é€Ÿæ“ä½œ -->
        <div class="quick-actions">
            <button class="quick-btn reset" onclick="resetAdjustments()">é‡ç½®</button>
            <button class="quick-btn" onclick="previewMarkdownCode()" style="background: #17a2b8; color: white;">é¢„è§ˆä»£ç </button>
            <button class="quick-btn apply" onclick="applyAdjustments()">åº”ç”¨</button>
        </div>

        <!-- å½“å‰é€‰ä¸­å…ƒç´ ä¿¡æ¯ -->
        <div id="selectedElementInfo" style="margin-top: 12px; padding: 8px; background: #f8f9fa; border-radius: 4px; font-size: 12px; color: #666; display: none;">
            <div><strong>å·²é€‰ä¸­:</strong> <span id="selectedElementText">æ— </span></div>
            <div id="selectedElementDetails" style="margin-top: 4px; font-family: monospace; font-size: 10px; color: #888; display: none;">
                <div>æ ‡ç­¾: <span id="elementTag"></span></div>
                <div>Alt: <span id="elementAlt"></span></div>
                <div>Src: <span id="elementSrc"></span></div>
            </div>
            <button onclick="toggleElementDetails()" style="margin-top: 4px; padding: 2px 6px; border: 1px solid #ddd; background: white; border-radius: 3px; font-size: 10px; cursor: pointer;">
                æ˜¾ç¤ºè¯¦æƒ…
            </button>
        </div>
    </div>
</div>

<!-- å¼•å…¥ jQuery -->
{% load static %}
<script src="{% static 'js/jquery-3.7.1.min.js' %}"></script>
<!-- ä¸ WebSocket è¿›è¡Œé€šä¿¡çš„è„šæœ¬ -->
<script>
    var slideId = {{ slide.id }};

    // è‡ªåŠ¨åˆ¤æ–­ä½¿ç”¨ ws:// æˆ– wss://
    var protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
    var socket = new WebSocket(protocol + window.location.host + '/ws/slide/' + slideId + '/');

    var currentIndices = {h: 0, v: 0};
    var editor = document.getElementById('editor');

    var slides = []; // å­˜å‚¨å¹»ç¯ç‰‡çš„ä½ç½®ä¿¡æ¯
    var lastSlideIndices = {h: -1, v: -1}; // è®°å½•ä¸Šä¸€æ¬¡çš„å¹»ç¯ç‰‡ç´¢å¼•

    socket.onopen = function (e) {
        console.log('WebSocket è¿æ¥å·²æ‰“å¼€');
        // åŠ è½½å¹»ç¯ç‰‡å†…å®¹
        socket.send(JSON.stringify({
            'action': 'load'
        }));
    };

    socket.onmessage = function (e) {
        var data = JSON.parse(e.data);
        var action = data['action'];

        if (action === 'load') {
            // åŠ è½½å†…å®¹åˆ°ç¼–è¾‘å™¨
            editor.value = data['content'] ;
            // è§£æå¹»ç¯ç‰‡
            slides = parseSlides(editor.value);

            // åˆå§‹åŠ è½½æ—¶æ›´æ–°é¢„è§ˆ
            sendPreview();

            // åˆå§‹è®¾ç½®å…‰æ ‡ä½ç½®äº‹ä»¶
            onCursorPositionChange();
        } else if (action === 'preview') {
            var html_content = data['html'];

            var iframe = document.getElementById('preview-iframe');

            // è·å–å½“å‰å¹»ç¯ç‰‡çš„ç´¢å¼•
            if (iframe.contentWindow && iframe.contentWindow.Reveal && iframe.contentWindow.Reveal.getIndices) {
                currentIndices = iframe.contentWindow.Reveal.getIndices();
            }

            // æ›´æ–°é¢„è§ˆ iframe çš„å†…å®¹
            iframe.contentDocument.open();
            iframe.contentDocument.write(html_content);
            iframe.contentDocument.close();

            // æ¸…é™¤é”™è¯¯æ¶ˆæ¯
            clearErrorMessage();

            // ç­‰å¾… iframe åŠ è½½å®Œæˆåï¼Œæ¢å¤å¹»ç¯ç‰‡ä½ç½®
            iframe.onload = function () {
                function restoreSlide() {
                    if (iframe.contentWindow.Reveal && iframe.contentWindow.Reveal.isReady()) {
                        iframe.contentWindow.Reveal.slide(currentIndices.h, currentIndices.v);

                        // å½“å¹»ç¯ç‰‡å˜åŒ–æ—¶ï¼Œæ›´æ–° currentIndices
                        iframe.contentWindow.Reveal.on('slidechanged', function (event) {
                            currentIndices = iframe.contentWindow.Reveal.getIndices();
                        });

                        // æ ¹æ®å…‰æ ‡ä½ç½®å¯¼èˆªåˆ°å¯¹åº”çš„å¹»ç¯ç‰‡
                        navigateToSlide(lastSlideIndices.h, lastSlideIndices.v);
                        
                        // å¯åŠ¨æ™ºèƒ½è°ƒæ•´åŠŸèƒ½
                        setTimeout(function() {
                            try {
                                if (iframe.contentWindow && iframe.contentWindow.AutoResize) {
                                    // ä½¿ç”¨æ–°çš„æ™ºèƒ½è°ƒæ•´æ–¹æ³•
                                    iframe.contentWindow.AutoResize.adjustSlide(iframe.contentWindow.Reveal.getCurrentSlide());
                                }
                                // è§¦å‘è‡ªå®šä¹‰äº‹ä»¶é€šçŸ¥å¹»ç¯ç‰‡å·²æ›´æ–°
                                if (iframe.contentDocument) {
                                    var event = new Event('slideUpdated');
                                    iframe.contentDocument.dispatchEvent(event);
                                }
                            } catch (e) {
                                console.log('æ™ºèƒ½è°ƒæ•´åŠŸèƒ½æš‚ä¸å¯ç”¨:', e.message);
                            }
                        }, 400);
                    } else {
                        setTimeout(restoreSlide, 50);
                    }
                }

                restoreSlide();
            };
        } else if (action === 'error') {
            var errorMessage = data['message'];
            displayErrorMessage(errorMessage);
        }
    };

    socket.onclose = function (e) {
        console.log('WebSocket è¿æ¥å·²å…³é—­');
    };

    // ç›‘å¬ç¼–è¾‘å™¨å†…å®¹çš„å˜åŒ–ï¼Œå®æ—¶é¢„è§ˆ
    $('#editor').on('input', function () {
        // æ›´æ–°å¹»ç¯ç‰‡è§£æ
        slides = parseSlides(editor.value);

        sendPreview();
    });

    function sendPreview() {
        var markdown = $('#editor').val();
        socket.send(JSON.stringify({
            'action': 'preview',
            'markdown': markdown
        }));
    }

    // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
    function displayErrorMessage(message) {
        // å¦‚æœä¸å­˜åœ¨é”™è¯¯æ¶ˆæ¯å…ƒç´ ï¼Œåˆ›å»ºä¸€ä¸ª
        if (!document.getElementById('error-message')) {
            var errorDiv = document.createElement('div');
            errorDiv.id = 'error-message';
            errorDiv.style.position = 'fixed';
            errorDiv.style.bottom = '20px';
            errorDiv.style.left = '20px';
            errorDiv.style.backgroundColor = 'rgba(255, 0, 0, 0.8)';
            errorDiv.style.color = '#fff';
            errorDiv.style.padding = '10px';
            errorDiv.style.borderRadius = '5px';
            errorDiv.style.maxWidth = '300px';
            errorDiv.style.zIndex = '1000';
            errorDiv.style.fontSize = '14px';
            errorDiv.style.lineHeight = '1.5';
            document.body.appendChild(errorDiv);
        }

        var errorDiv = document.getElementById('error-message');
        errorDiv.textContent = 'è¯­æ³•é”™è¯¯ï¼š' + message;
    }

    // æ¸…é™¤é”™è¯¯æ¶ˆæ¯
    function clearErrorMessage() {
        var errorDiv = document.getElementById('error-message');
        if (errorDiv) {
            errorDiv.parentNode.removeChild(errorDiv);
        }
    }

    // è‡ªåŠ¨ä¿å­˜åŠŸèƒ½ï¼Œæ¯åˆ†é’Ÿä¿å­˜ä¸€æ¬¡
    setInterval(function () {
        saveSlide();
    }, 60000);

    // åœ¨ç¦»å¼€é¡µé¢å‰ä¿å­˜å¹»ç¯ç‰‡å†…å®¹
    window.addEventListener('beforeunload', function () {
        saveSlide();
    });

    // ä¿å­˜å¹»ç¯ç‰‡å†…å®¹çš„å‡½æ•°
    function saveSlide() {
        var markdown = $('#editor').val();
        socket.send(JSON.stringify({
            'action': 'save',
            'markdown': markdown
        }));
    }

    // è§£æå¹»ç¯ç‰‡å†…å®¹ï¼Œæ‰¾å‡ºæ¯ä¸ªå¹»ç¯ç‰‡çš„å¼€å§‹ä½ç½®
    function parseSlides(content) {
        var lines = content.split('\n');
        var slideStart = [];
        var slide = {start: 0, h: 0, v: 0};
        var h = 0;
        var v = 0;

        for (var i = 0; i < lines.length; i++) {
            if (lines[i].trim() === '---') {
                slideStart.push({start: i, h: h, v: v});
                h++;
            }
        }

        return slideStart;
    }

    // ç›‘å¬å…‰æ ‡ä½ç½®å˜åŒ–
    function onCursorPositionChange() {
        editor.addEventListener('click', updateCursorPosition);
        editor.addEventListener('keyup', updateCursorPosition);
    }

    // æ ¹æ®å…‰æ ‡ä½ç½®æ›´æ–°é¢„è§ˆçš„å¹»ç¯ç‰‡
    function updateCursorPosition() {
        var cursorPosition = editor.selectionStart;
        var content = editor.value.substring(0, cursorPosition);
        var lines = content.split('\n');
        var currentLine = lines.length;

        // æ‰¾å‡ºå½“å‰å…‰æ ‡æ‰€åœ¨çš„å¹»ç¯ç‰‡
        var currentSlideIndex = -1;

        for (var i = 0; i < slides.length; i++) {
            if (currentLine <= slides[i].start) {
                currentSlideIndex = i - 1;
                break;
            }
        }

        if (currentSlideIndex === -1 && slides.length > 0) {
            currentSlideIndex = slides.length - 1;
        }

        // å¦‚æœæ‰¾åˆ°äº†åˆé€‚çš„å¹»ç¯ç‰‡ï¼Œå¹¶ä¸”ä¸ä¸Šä¸€æ¬¡ä¸åŒ
        if (currentSlideIndex >= 0 && (
            lastSlideIndices.h !== slides[currentSlideIndex].h ||
            lastSlideIndices.v !== slides[currentSlideIndex].v)) {
            // æ›´æ–°ä¸Šä¸€æ¬¡çš„ç´¢å¼•
            lastSlideIndices.h = slides[currentSlideIndex].h;
            lastSlideIndices.v = slides[currentSlideIndex].v;
            // å¯¼èˆªåˆ°ç›¸åº”çš„å¹»ç¯ç‰‡
            navigateToSlide(lastSlideIndices.h, lastSlideIndices.v);
        }
    }

    // å¯¼èˆªåˆ°æŒ‡å®šçš„å¹»ç¯ç‰‡
    function navigateToSlide(h, v) {
        var iframe = document.getElementById('preview-iframe');
        if (iframe.contentWindow && iframe.contentWindow.Reveal && iframe.contentWindow.Reveal.isReady()) {
            iframe.contentWindow.Reveal.slide(h, v);
        }
    }

    // å›¾ç‰‡æœç´¢åŠŸèƒ½
    function openImageSearch() {
        document.getElementById('imageSearchModal').style.display = 'block';
    }

    function closeImageSearch() {
        document.getElementById('imageSearchModal').style.display = 'none';
    }

    function searchImages(event) {
        event.preventDefault();
        
        const keywords = document.getElementById('imageKeywords').value.trim();
        if (!keywords) return;
        
        // æ˜¾ç¤ºåŠ è½½ä¸­ï¼Œéšè—å…¶ä»–
        document.getElementById('loadingImages').style.display = 'block';
        document.getElementById('noResults').style.display = 'none';
        document.getElementById('imageResults').innerHTML = '';
        
        // å‘é€AJAXè¯·æ±‚
        $.ajax({
            url: '{% url "add_image_to_slide" %}',
            type: 'POST',
            data: {
                'keywords': keywords,
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            success: function(response) {
                document.getElementById('loadingImages').style.display = 'none';
                
                if (response.images && response.images.length > 0) {
                    displayImages(response.images);
                } else {
                    document.getElementById('noResults').style.display = 'block';
                }
            },
            error: function(xhr, status, error) {
                document.getElementById('loadingImages').style.display = 'none';
                document.getElementById('noResults').style.display = 'block';
                console.error('æœç´¢å›¾ç‰‡å¤±è´¥:', error);
            }
        });
    }

    function displayImages(images) {
        const resultsDiv = document.getElementById('imageResults');
        resultsDiv.innerHTML = '';
        
        images.forEach(function(image) {
            const imageItem = document.createElement('div');
            imageItem.className = 'image-item';
            
            const img = document.createElement('img');
            img.src = image.url;
            img.alt = image.alt;
            
            const credit = document.createElement('div');
            credit.className = 'credit-text';
            credit.innerHTML = `Photo by <a href="${image.credit.link}" target="_blank">${image.credit.name}</a> on Unsplash`;
            
            imageItem.appendChild(img);
            imageItem.appendChild(credit);
            
            // ç‚¹å‡»å›¾ç‰‡æ’å…¥åˆ°ç¼–è¾‘å™¨
            imageItem.addEventListener('click', function() {
                insertImageToEditor(image);
                closeImageSearch();
            });
            
            resultsDiv.appendChild(imageItem);
        });
    }

    function insertImageToEditor(image) {
        // è·å–å…‰æ ‡ä½ç½®
        const cursorPosition = editor.selectionStart;
        
        // å‡†å¤‡Markdownæ ¼å¼çš„å›¾ç‰‡
        const markdownImage = `\n![${image.alt}](${image.url})\n*Photo by [${image.credit.name}](${image.credit.link}) on Unsplash*\n`;
        
        // åœ¨å…‰æ ‡ä½ç½®æ’å…¥å›¾ç‰‡
        const content = editor.value;
        editor.value = content.substring(0, cursorPosition) + markdownImage + content.substring(cursorPosition);
        
        // æ›´æ–°é¢„è§ˆ
        sendPreview();
        
        // ä¿å­˜
        saveSlide();
    }

    // å…³é—­æ¨¡æ€æ¡†çš„äº‹ä»¶ç›‘å¬
    window.onclick = function(event) {
        const modal = document.getElementById('imageSearchModal');
        if (event.target === modal) {
            closeImageSearch();
        }
    };
    
    // å¯¼å‡ºå¹»ç¯ç‰‡ä¸ºPPTX
    function exportSlide() {
        // å…ˆä¿å­˜å¹»ç¯ç‰‡
        saveSlide();
        
        // å¼¹å‡ºæç¤º
        const confirmed = confirm('å°†ç”ŸæˆPPTXæ ¼å¼æ–‡ä»¶ä¾›ä¸‹è½½ï¼Œè¿‡ç¨‹å¯èƒ½éœ€è¦å‡ ç§’é’Ÿï¼Œç¡®å®šè¦å¯¼å‡ºå—ï¼Ÿ');
        if (confirmed) {
            // æ˜¾ç¤ºåŠ è½½ä¸­æç¤º
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'export-loading';
            loadingDiv.style.position = 'fixed';
            loadingDiv.style.top = '50%';
            loadingDiv.style.left = '50%';
            loadingDiv.style.transform = 'translate(-50%, -50%)';
            loadingDiv.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
            loadingDiv.style.color = '#fff';
            loadingDiv.style.padding = '20px';
            loadingDiv.style.borderRadius = '5px';
            loadingDiv.style.zIndex = '2000';
            loadingDiv.innerHTML = '<p>æ­£åœ¨ç”ŸæˆPPTXï¼Œè¯·ç¨å€™...</p>';
            document.body.appendChild(loadingDiv);
            
            // æ‰§è¡Œå¯¼å‡ºæ“ä½œ
            window.location.href = '{% url 'export_to_pptx' slide_id=slide.id %}';
            
            // 5ç§’åç§»é™¤åŠ è½½æç¤º
            setTimeout(function() {
                const loadingElement = document.getElementById('export-loading');
                if (loadingElement) {
                    loadingElement.parentNode.removeChild(loadingElement);
                }
            }, 5000);
        }
    }

    // =============== æ‰‹åŠ¨è°ƒèŠ‚åŠŸèƒ½ ===============
    
    let selectedElement = null;
    let originalStyles = new Map();
    let adjustmentPanelVisible = false;

    // åˆ‡æ¢è°ƒèŠ‚é¢æ¿æ˜¾ç¤º/éšè—
    function toggleAdjustmentPanel() {
        const panel = document.getElementById('adjustmentPanel');
        adjustmentPanelVisible = !adjustmentPanelVisible;
        
        if (adjustmentPanelVisible) {
            panel.style.display = 'block';
            initializeElementSelection();
        } else {
            panel.style.display = 'none';
            clearElementSelection();
        }
    }

    // åˆå§‹åŒ–å…ƒç´ é€‰æ‹©åŠŸèƒ½
    function initializeElementSelection() {
        const iframe = document.getElementById('preview-iframe');
        if (!iframe.contentDocument) return;

        // ä¸ºé¢„è§ˆåŒºåŸŸçš„æ‰€æœ‰å¯è°ƒèŠ‚å…ƒç´ æ·»åŠ ç‚¹å‡»äº‹ä»¶
        const selectableElements = iframe.contentDocument.querySelectorAll('p, h1, h2, h3, h4, h5, h6, img, li, span');
        
        selectableElements.forEach(element => {
            element.style.cursor = 'pointer';
            element.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                selectElement(element);
            });
            
            // æ·»åŠ æ‚¬åœæ•ˆæœ
            element.addEventListener('mouseenter', function() {
                if (element !== selectedElement) {
                    element.style.outline = '2px dashed #007bff';
                }
            });
            
            element.addEventListener('mouseleave', function() {
                if (element !== selectedElement) {
                    element.style.outline = 'none';
                }
            });
        });
    }

    // é€‰æ‹©å…ƒç´ 
    function selectElement(element) {
        // æ¸…é™¤ä¹‹å‰é€‰ä¸­çš„å…ƒç´ 
        if (selectedElement) {
            selectedElement.classList.remove('element-selector');
            selectedElement.style.outline = 'none';
        }
        
        selectedElement = element;
        element.classList.add('element-selector');
        
        // ä¿å­˜åŸå§‹æ ·å¼
        if (!originalStyles.has(element)) {
            const computedStyles = window.getComputedStyle(element);
            originalStyles.set(element, {
                fontSize: computedStyles.fontSize,
                width: computedStyles.width,
                height: computedStyles.height,
                textAlign: computedStyles.textAlign,
                margin: computedStyles.margin,
                maxWidth: computedStyles.maxWidth,
                maxHeight: computedStyles.maxHeight
            });
        }
        
        // æ›´æ–°æ§åˆ¶é¢æ¿
        updateControlPanel(element);
        
        // æ˜¾ç¤ºé€‰ä¸­ä¿¡æ¯
        const info = document.getElementById('selectedElementInfo');
        const infoText = document.getElementById('selectedElementText');
        info.style.display = 'block';
        infoText.textContent = getElementDescription(element);
        
        // æ›´æ–°è¯¦ç»†ä¿¡æ¯
        updateElementDetails(element);
    }

    // è·å–å…ƒç´ æè¿°
    function getElementDescription(element) {
        const tagName = element.tagName.toLowerCase();
        if (tagName === 'img') {
            return `å›¾ç‰‡ (${element.alt || 'æ— æè¿°'})`;
        } else if (['h1', 'h2', 'h3', 'h4', 'h5', 'h6'].includes(tagName)) {
            return `${tagName.toUpperCase()}æ ‡é¢˜: ${element.textContent.substring(0, 20)}...`;
        } else {
            return `${tagName}æ–‡æœ¬: ${element.textContent.substring(0, 20)}...`;
        }
    }

    // æ›´æ–°æ§åˆ¶é¢æ¿
    function updateControlPanel(element) {
        const isImage = element.tagName.toLowerCase() === 'img';
        const isText = !isImage;
        
        // æ˜¾ç¤º/éšè—ç›¸å…³æ§ä»¶
        document.getElementById('fontSizeControl').style.display = isText ? 'block' : 'none';
        document.getElementById('imageSizeControl').style.display = isImage ? 'block' : 'none';
        
        if (isText) {
            // æ›´æ–°å­—ä½“å¤§å°æ»‘å—
            const fontSize = parseInt(window.getComputedStyle(element).fontSize);
            document.getElementById('fontSizeSlider').value = fontSize;
            document.getElementById('fontSizeValue').textContent = fontSize + 'px';
        }
        
        if (isImage) {
            // æ›´æ–°å›¾ç‰‡å¤§å°æ»‘å—
            const rect = element.getBoundingClientRect();
            const containerRect = element.parentElement.getBoundingClientRect();
            const widthPercent = Math.round((rect.width / containerRect.width) * 100);
            const heightPercent = Math.round((rect.height / containerRect.height) * 100);
            
            document.getElementById('imageWidthSlider').value = widthPercent;
            document.getElementById('imageWidthValue').textContent = widthPercent + '%';
            document.getElementById('imageHeightSlider').value = heightPercent;
            document.getElementById('imageHeightValue').textContent = heightPercent + '%';
        }
        
        // æ›´æ–°è¾¹è·æ»‘å—
        const marginValue = parseInt(window.getComputedStyle(element).margin) || 15;
        document.getElementById('marginSlider').value = marginValue;
        document.getElementById('marginValue').textContent = marginValue + 'px';
    }

    // æŒ‰å…ƒç´ ç±»å‹é€‰æ‹©
    function selectElementType(type) {
        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        document.querySelectorAll('.control-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        
        const iframe = document.getElementById('preview-iframe');
        if (!iframe.contentDocument) return;
        
        let selector = '';
        switch(type) {
            case 'text':
                selector = 'p, li, span';
                break;
            case 'image':
                selector = 'img';
                break;
            case 'heading':
                selector = 'h1, h2, h3, h4, h5, h6';
                break;
        }
        
        const elements = iframe.contentDocument.querySelectorAll(selector);
        if (elements.length > 0) {
            selectElement(elements[0]); // é€‰æ‹©ç¬¬ä¸€ä¸ªåŒ¹é…çš„å…ƒç´ 
        }
    }

    // è°ƒæ•´å­—ä½“å¤§å°
    function adjustFontSize(size) {
        if (!selectedElement) return;
        
        selectedElement.style.fontSize = size + 'px';
        document.getElementById('fontSizeValue').textContent = size + 'px';
    }

    // å¿«é€Ÿè®¾ç½®å­—ä½“å¤§å°
    function quickFontSize(size) {
        document.getElementById('fontSizeSlider').value = size;
        adjustFontSize(size);
    }

    // è°ƒæ•´å›¾ç‰‡å¤§å°
    function adjustImageSize(dimension, value) {
        if (!selectedElement || selectedElement.tagName.toLowerCase() !== 'img') return;
        
        if (dimension === 'width') {
            selectedElement.style.width = value + '%';
            selectedElement.style.maxWidth = value + '%';
            document.getElementById('imageWidthValue').textContent = value + '%';
        } else if (dimension === 'height') {
            selectedElement.style.height = value + 'vh';
            selectedElement.style.maxHeight = value + 'vh';
            document.getElementById('imageHeightValue').textContent = value + '%';
        }
    }

    // å¿«é€Ÿè®¾ç½®å›¾ç‰‡å¤§å°
    function quickImageSize(width, height) {
        document.getElementById('imageWidthSlider').value = width;
        document.getElementById('imageHeightSlider').value = height;
        adjustImageSize('width', width);
        adjustImageSize('height', height);
    }

    // è°ƒæ•´å¯¹é½æ–¹å¼
    function adjustAlignment(align) {
        if (!selectedElement) return;
        
        selectedElement.style.textAlign = align;
        
        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        document.querySelectorAll('#positionControl .control-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        event.target.classList.add('active');
    }

    // è°ƒæ•´è¾¹è·
    function adjustMargin(value) {
        if (!selectedElement) return;
        
        selectedElement.style.margin = value + 'px auto';
        document.getElementById('marginValue').textContent = value + 'px';
    }

    // é‡ç½®è°ƒæ•´
    function resetAdjustments() {
        if (!selectedElement) return;
        
        const original = originalStyles.get(selectedElement);
        if (original) {
            selectedElement.style.fontSize = original.fontSize;
            selectedElement.style.width = original.width;
            selectedElement.style.height = original.height;
            selectedElement.style.textAlign = original.textAlign;
            selectedElement.style.margin = original.margin;
            selectedElement.style.maxWidth = original.maxWidth;
            selectedElement.style.maxHeight = original.maxHeight;
            
            // æ›´æ–°æ§åˆ¶é¢æ¿
            updateControlPanel(selectedElement);
        }
    }

    // åº”ç”¨è°ƒæ•´ï¼ˆå°†æ ·å¼å›ºåŒ–åˆ°Markdownï¼‰
    function applyAdjustments() {
        if (!selectedElement) {
            alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå…ƒç´ ');
            return;
        }
        
        try {
            const elementInfo = analyzeSelectedElement();
            if (!elementInfo) {
                alert('æ— æ³•åˆ†æé€‰ä¸­çš„å…ƒç´ ');
                return;
            }
            
            const newMarkdown = updateMarkdownWithStyles(elementInfo);
            if (newMarkdown) {
                // æ›´æ–°ç¼–è¾‘å™¨å†…å®¹
                editor.value = newMarkdown;
                
                // é‡æ–°è§£æå¹¶æ›´æ–°é¢„è§ˆ
                slides = parseSlides(editor.value);
                sendPreview();
                
                // ä¿å­˜
                saveSlide();
                
                alert('æ ·å¼å·²åº”ç”¨åˆ°Markdownæ–‡æœ¬ä¸­ï¼');
                console.log('æ ·å¼å·²æˆåŠŸå†™å…¥Markdown');
            } else {
                alert('åº”ç”¨æ ·å¼å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        } catch (error) {
            console.error('åº”ç”¨æ ·å¼æ—¶å‡ºé”™:', error);
            alert('åº”ç”¨æ ·å¼æ—¶å‡ºç°é”™è¯¯: ' + error.message);
        }
    }

    // åˆ†æé€‰ä¸­çš„å…ƒç´ 
    function analyzeSelectedElement() {
        if (!selectedElement) return null;
        
        const tagName = selectedElement.tagName.toLowerCase();
        const textContent = selectedElement.textContent;
        const computedStyles = window.getComputedStyle(selectedElement);
        
        // è·å–å½“å‰åº”ç”¨çš„æ ·å¼
        const appliedStyles = {
            fontSize: selectedElement.style.fontSize || '',
            width: selectedElement.style.width || '',
            height: selectedElement.style.height || '',
            maxWidth: selectedElement.style.maxWidth || '',
            maxHeight: selectedElement.style.maxHeight || '',
            textAlign: selectedElement.style.textAlign || '',
            margin: selectedElement.style.margin || ''
        };
        
        // è¿‡æ»¤ç©ºå€¼
        const validStyles = {};
        Object.keys(appliedStyles).forEach(key => {
            if (appliedStyles[key] && appliedStyles[key].trim() !== '') {
                validStyles[key] = appliedStyles[key];
            }
        });
        
        return {
            tagName,
            textContent: textContent.trim(),
            styles: validStyles,
            isImage: tagName === 'img',
            alt: tagName === 'img' ? selectedElement.alt : '',
            src: tagName === 'img' ? selectedElement.src : ''
        };
    }

    // å°†æ ·å¼æ›´æ–°åˆ°Markdownæ–‡æœ¬ä¸­
    function updateMarkdownWithStyles(elementInfo) {
        const markdownContent = editor.value;
        const lines = markdownContent.split('\n');
        
        if (elementInfo.isImage) {
            return updateImageInMarkdown(lines, elementInfo);
        } else {
            return updateTextInMarkdown(lines, elementInfo);
        }
    }

    // æ›´æ–°å›¾ç‰‡åœ¨Markdownä¸­çš„æ ·å¼
    function updateImageInMarkdown(lines, elementInfo) {
        const imageText = elementInfo.alt;
        const imageSrc = elementInfo.src;
        
        // æ„å»ºæ ·å¼å­—ç¬¦ä¸²
        const styleString = buildStyleString(elementInfo.styles);
        
        console.log('æ­£åœ¨æ›´æ–°å›¾ç‰‡:', {
            alt: imageText,
            src: imageSrc,
            styles: elementInfo.styles
        });
        
        let updated = false;
        
        for (let i = 0; i < lines.length; i++) {
            const line = lines[i];
            
            // åŒ¹é…æ ‡å‡†Markdownå›¾ç‰‡è¯­æ³•: ![alt](src)
            const markdownImageRegex = /!\[([^\]]*)\]\(([^)]+)\)/;
            const markdownMatch = line.match(markdownImageRegex);
            
            if (markdownMatch) {
                const [fullMatch, alt, src] = markdownMatch;
                
                console.log('æ£€æŸ¥Markdownå›¾ç‰‡:', { alt, src, target: imageText });
                
                // æ£€æŸ¥æ˜¯å¦æ˜¯ç›®æ ‡å›¾ç‰‡ï¼ˆé€šè¿‡altæˆ–srcçš„ç›¸ä¼¼æ€§åŒ¹é…ï¼‰
                if (isImageMatch(alt, src, imageText, imageSrc)) {
                    // æ›¿æ¢ä¸ºHTMLæ ¼å¼ï¼ŒåŒ…å«æ ·å¼
                    const newImageTag = `<img alt="${alt}" src="${src}"${styleString}>`;
                    lines[i] = line.replace(fullMatch, newImageTag);
                    console.log('æ›´æ–°Markdownå›¾ç‰‡ä¸º:', newImageTag);
                    updated = true;
                    break;
                }
            }
            
            // åŒ¹é…å·²æœ‰çš„HTMLå›¾ç‰‡æ ‡ç­¾
            const htmlImageRegex = /<img[^>]*>/;
            if (htmlImageRegex.test(line)) {
                // æ›´ç²¾ç¡®çš„HTMLå›¾ç‰‡åŒ¹é…
                const altMatch = line.match(/alt=["']([^"']*)["']/);
                const srcMatch = line.match(/src=["']([^"']*)["']/);
                
                if (altMatch && srcMatch) {
                    const alt = altMatch[1];
                    const src = srcMatch[1];
                    
                    console.log('æ£€æŸ¥HTMLå›¾ç‰‡:', { alt, src, target: imageText });
                    
                    if (isImageMatch(alt, src, imageText, imageSrc)) {
                        // æ›´æ–°ç°æœ‰HTMLæ ‡ç­¾çš„æ ·å¼
                        const originalTag = line.match(/<img[^>]*>/)[0];
                        const newImageTag = updateExistingImageTag(originalTag, elementInfo.styles);
                        lines[i] = line.replace(originalTag, newImageTag);
                        console.log('æ›´æ–°HTMLå›¾ç‰‡ä¸º:', newImageTag);
                        updated = true;
                        break;
                    }
                }
            }
        }
        
        if (!updated) {
            console.warn('æœªæ‰¾åˆ°åŒ¹é…çš„å›¾ç‰‡ï¼Œæ— æ³•æ›´æ–°');
        }
        
        return lines.join('\n');
    }

    // æ£€æŸ¥å›¾ç‰‡æ˜¯å¦åŒ¹é…
    function isImageMatch(alt1, src1, alt2, src2) {
        // 1. é€šè¿‡altå±æ€§åŒ¹é…
        if (alt1 && alt2 && alt1.trim() === alt2.trim()) {
            return true;
        }
        
        // 2. é€šè¿‡srcçš„æ–‡ä»¶ååŒ¹é…
        const filename1 = getImageFilename(src1);
        const filename2 = getImageFilename(src2);
        if (filename1 && filename2 && filename1 === filename2) {
            return true;
        }
        
        // 3. é€šè¿‡srcçš„éƒ¨åˆ†åŒ¹é…ï¼ˆå¤„ç†å®Œæ•´URL vs ç›¸å¯¹è·¯å¾„çš„æƒ…å†µï¼‰
        if (src1 && src2) {
            // å¦‚æœå…¶ä¸­ä¸€ä¸ªåŒ…å«å¦ä¸€ä¸ª
            if (src1.includes(src2) || src2.includes(src1)) {
                return true;
            }
            
            // å¦‚æœå»æ‰åè®®å’ŒåŸŸååç›¸åŒ
            const cleanSrc1 = src1.replace(/^https?:\/\/[^\/]+/, '');
            const cleanSrc2 = src2.replace(/^https?:\/\/[^\/]+/, '');
            if (cleanSrc1 === cleanSrc2) {
                return true;
            }
        }
        
        return false;
    }

    // æ›´æ–°æ–‡æœ¬åœ¨Markdownä¸­çš„æ ·å¼
    function updateTextInMarkdown(lines, elementInfo) {
        const targetText = elementInfo.textContent;
        const styleString = buildStyleString(elementInfo.styles);
        
        for (let i = 0; i < lines.length; i++) {
            const line = lines[i].trim();
            
            // è·³è¿‡ç©ºè¡Œå’Œéæ–‡æœ¬è¡Œ
            if (!line || line.startsWith('#') || line.startsWith('```') || line.startsWith('---')) {
                continue;
            }
            
            // æ£€æŸ¥è¡Œæ˜¯å¦åŒ…å«ç›®æ ‡æ–‡æœ¬
            if (line.includes(targetText) || normalizeText(line).includes(normalizeText(targetText))) {
                // æ ¹æ®å…ƒç´ ç±»å‹å¤„ç†
                if (elementInfo.tagName.startsWith('h')) {
                    // æ ‡é¢˜å…ƒç´  - ä¿æŒMarkdownè¯­æ³•ï¼Œåœ¨ä¸‹ä¸€è¡Œæ·»åŠ HTMLæ ‡ç­¾
                    if (!lines[i + 1] || !lines[i + 1].includes('<' + elementInfo.tagName)) {
                        lines.splice(i + 1, 0, `<${elementInfo.tagName}${styleString}>${targetText}</${elementInfo.tagName}>`);
                        lines[i] = ''; // æ¸…ç©ºåŸå§‹Markdownæ ‡é¢˜è¡Œ
                    }
                } else {
                    // æ™®é€šæ–‡æœ¬ - ç›´æ¥æ›¿æ¢ä¸ºHTMLæ ‡ç­¾
                    const htmlTag = `<${elementInfo.tagName}${styleString}>${targetText}</${elementInfo.tagName}>`;
                    lines[i] = lines[i].replace(targetText, htmlTag);
                }
                break;
            }
        }
        
        return lines.join('\n');
    }

    // æ„å»ºæ ·å¼å­—ç¬¦ä¸²
    function buildStyleString(styles) {
        if (!styles || Object.keys(styles).length === 0) {
            return '';
        }
        
        const styleArray = [];
        Object.keys(styles).forEach(property => {
            const value = styles[property];
            if (value) {
                // è½¬æ¢é©¼å³°å‘½åä¸ºCSSå±æ€§å
                const cssProperty = property.replace(/([A-Z])/g, '-$1').toLowerCase();
                styleArray.push(`${cssProperty}: ${value}`);
            }
        });
        
        return styleArray.length > 0 ? ` style="${styleArray.join('; ')}"` : '';
    }

    // æ›´æ–°ç°æœ‰å›¾ç‰‡æ ‡ç­¾çš„æ ·å¼
    function updateExistingImageTag(imageTag, newStyles) {
        const styleString = buildStyleString(newStyles);
        
        console.log('æ›´æ–°å›¾ç‰‡æ ‡ç­¾:', { 
            originalTag: imageTag, 
            newStyles: newStyles,
            styleString: styleString 
        });
        
        // ç§»é™¤ç°æœ‰çš„styleå±æ€§
        let updatedTag = imageTag.replace(/\s+style=["'][^"']*["']/g, '');
        
        // ç¡®ä¿æ ‡ç­¾ä»¥>ç»“å°¾
        if (!updatedTag.endsWith('>')) {
            updatedTag += '>';
        }
        
        // æ·»åŠ æ–°çš„styleå±æ€§
        if (styleString) {
            // åœ¨>ä¹‹å‰æ’å…¥styleå±æ€§
            updatedTag = updatedTag.replace(/>$/, `${styleString}>`);
        }
        
        console.log('æ›´æ–°åçš„æ ‡ç­¾:', updatedTag);
        return updatedTag;
    }

    // è·å–å›¾ç‰‡æ–‡ä»¶å
    function getImageFilename(src) {
        if (!src) return '';
        
        try {
            // ç§»é™¤æŸ¥è¯¢å‚æ•°å’Œé”šç‚¹
            let cleanSrc = src.split('?')[0].split('#')[0];
            
            // æå–æ–‡ä»¶å
            let filename = cleanSrc.split('/').pop();
            
            // å¦‚æœæ–‡ä»¶åä¸ºç©ºæˆ–åªæ˜¯è·¯å¾„åˆ†éš”ç¬¦ï¼Œå°è¯•è·å–å€’æ•°ç¬¬äºŒä¸ªéƒ¨åˆ†
            if (!filename || filename === '') {
                const parts = cleanSrc.split('/').filter(part => part.length > 0);
                filename = parts.length > 0 ? parts[parts.length - 1] : '';
            }
            
            return filename;
        } catch (error) {
            console.error('æå–æ–‡ä»¶åå¤±è´¥:', error);
            return '';
        }
    }

    // æ ‡å‡†åŒ–æ–‡æœ¬ï¼ˆç§»é™¤å¤šä½™ç©ºæ ¼å’Œæ ‡ç‚¹ï¼‰
    function normalizeText(text) {
        return text.replace(/\s+/g, ' ').replace(/[^\w\s\u4e00-\u9fff]/g, '').trim();
    }

    // é¢„è§ˆMarkdownä»£ç 
    function previewMarkdownCode() {
        if (!selectedElement) {
            alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå…ƒç´ ');
            return;
        }
        
        try {
            const elementInfo = analyzeSelectedElement();
            if (!elementInfo) {
                alert('æ— æ³•åˆ†æé€‰ä¸­çš„å…ƒç´ ');
                return;
            }
            
            // ç”Ÿæˆé¢„è§ˆä»£ç 
            const previewCode = generatePreviewCode(elementInfo);
            
            // æ˜¾ç¤ºé¢„è§ˆåŒºåŸŸ
            document.getElementById('codePreview').style.display = 'block';
            document.getElementById('markdownPreview').value = previewCode;
            
        } catch (error) {
            console.error('ç”Ÿæˆé¢„è§ˆä»£ç æ—¶å‡ºé”™:', error);
            alert('ç”Ÿæˆé¢„è§ˆä»£ç æ—¶å‡ºç°é”™è¯¯: ' + error.message);
        }
    }

    // ç”Ÿæˆé¢„è§ˆä»£ç 
    function generatePreviewCode(elementInfo) {
        const styleString = buildStyleString(elementInfo.styles);
        
        if (elementInfo.isImage) {
            // å›¾ç‰‡å…ƒç´ 
            return `<img alt="${elementInfo.alt}" src="${elementInfo.src}"${styleString}>`;
        } else if (elementInfo.tagName.startsWith('h')) {
            // æ ‡é¢˜å…ƒç´ 
            return `<${elementInfo.tagName}${styleString}>${elementInfo.textContent}</${elementInfo.tagName}>`;
        } else {
            // æ™®é€šæ–‡æœ¬å…ƒç´ 
            return `<${elementInfo.tagName}${styleString}>${elementInfo.textContent}</${elementInfo.tagName}>`;
        }
    }

    // æ¸…é™¤å…ƒç´ é€‰æ‹©
    function clearElementSelection() {
        if (selectedElement) {
            selectedElement.classList.remove('element-selector');
            selectedElement.style.outline = 'none';
            selectedElement = null;
        }
        
        // æ¸…é™¤æ‰€æœ‰å…ƒç´ çš„æ‚¬åœæ•ˆæœ
        const iframe = document.getElementById('preview-iframe');
        if (iframe.contentDocument) {
            const elements = iframe.contentDocument.querySelectorAll('*');
            elements.forEach(element => {
                element.style.cursor = '';
                element.style.outline = 'none';
            });
        }
    }

    // æ›´æ–°å…ƒç´ è¯¦ç»†ä¿¡æ¯
    function updateElementDetails(element) {
        const tagName = element.tagName.toLowerCase();
        document.getElementById('elementTag').textContent = tagName;
        
        if (tagName === 'img') {
            document.getElementById('elementAlt').textContent = element.alt || '(æ— )';
            document.getElementById('elementSrc').textContent = element.src ? element.src.substring(0, 50) + '...' : '(æ— )';
        } else {
            document.getElementById('elementAlt').textContent = '(éå›¾ç‰‡)';
            document.getElementById('elementSrc').textContent = '(éå›¾ç‰‡)';
        }
    }

    // åˆ‡æ¢å…ƒç´ è¯¦æƒ…æ˜¾ç¤º
    function toggleElementDetails() {
        const details = document.getElementById('selectedElementDetails');
        const button = event.target;
        
        if (details.style.display === 'none' || !details.style.display) {
            details.style.display = 'block';
            button.textContent = 'éšè—è¯¦æƒ…';
        } else {
            details.style.display = 'none';
            button.textContent = 'æ˜¾ç¤ºè¯¦æƒ…';
        }
    }

    // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
        // ç›‘å¬iframeåŠ è½½å®Œæˆ
        const iframe = document.getElementById('preview-iframe');
        iframe.addEventListener('load', function() {
            if (adjustmentPanelVisible) {
                setTimeout(initializeElementSelection, 500);
            }
        });
    });
</script>
</body>
</html>